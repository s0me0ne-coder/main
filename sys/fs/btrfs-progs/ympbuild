#!/usr/bin/env bash
name='btrfs-progs'
release='1'
version='6.3'
url='https://github.com/storaged-project/libblockdev'
description='A library for manipulating block devices'
email='bayramk@gmail.com'
maintainer='bk'
license=('GPLv3')
source=("https://github.com/kdave/btrfs-progs/archive/refs/tags/v6.3.tar.gz"
	'initcpio-install-btrfs'
        'initcpio-hook-btrfs'
        'btrfs-scrub@.service'
        'btrfs-scrub@.timer'
)
depends=( e2fsprogs zlib libgcrypt libzstd)
makedepends=()
md5sums=('4806f9346f55cfbea44f9e423541e17c'
'SKIP'
'SKIP'
'SKIP'
'SKIP')
group=(sys.fs)
uses=()
arch=('x86_64')

install=btrfs-progs.install
options=(!staticlibs)

cd $name-$version
prepare() {
  # apply patch from the source array (should be a pacman feature)
  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src = *.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 < "../$src"
  done
}


setup(){
	./autogen.sh
	./configure --prefix=/usr \
        --libdir=/usr/lib64/  --with-crypto=libgcrypt \
        --disable-zstd \
        --disable-py3-sphinx
}

build(){
    make $jobs
}

package(){
make DESTDIR="$DESTDIR" install install_python

  # install bash completion (FS#44618)
  install -Dm644 btrfs-completion "$DESTDIR/usr/share/bash-completion/completions/btrfs"

  # install mkinitcpio hooks
 # cd "$srcdir"
   install -Dm644 ../initcpio-hook-btrfs "$DESTDIR/usr/lib/initcpio/hooks/btrfs"
   install -Dm644 ../initcpio-install-btrfs "$DESTDIR/usr/lib/initcpio/install/btrfs"

  # install scrub service/timer
  install -Dm644 ../btrfs-scrub@.service "$DESTDIR/usr/lib/systemd/system/btrfs-scrub@.service"
  install -Dm644 ../btrfs-scrub@.timer "$DESTDIR/usr/lib/systemd/system/btrfs-scrub@.timer"

}

